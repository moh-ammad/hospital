// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

// Prisma Schema for Multi-Tenant CRM-EMR Integration
generator client {
  provider = "prisma-client-js"
  output   = "../generated/prisma"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

// Support multiple clients/practices via UI entry
model Client {
  id Int @id @default(autoincrement())

  // Name is just a label now (NOT identity)
  name String

  active Boolean @default(true)

  // TRUE identity for IntakeQ
  intakeQKey     String @unique
  intakeQBaseUrl String @default("https://intakeq.com/api/v1")

  // Vtiger (CRM)
  vtigerUrl       String
  vtigerUsername  String?
  vtigerAccessKey String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations (unchanged, SAFE)
  appointments Appointment[]
  leads        Lead[]

  // Keep index for searching by name
  @@index([name])
}

model Lead {
  // Internal DB ID
  id Int @id @default(autoincrement())

  // Tenant / Client
  clientId Int
  client   Client @relation(fields: [clientId], references: [id], onDelete: Cascade)

  // --- VTIGER CORE IDS ---
  // Example: "10x1046"
  vtigerId String  @unique
  lead_no  String?

  // --- NAME & CONTACT ---
  salutationtype String?
  firstname      String?
  lastname       String?
  email          String?
  phone          String?
  mobile         String?
  secondaryemail String?
  fax            String?

  // --- COMPANY & PROFESSIONAL ---
  company     String?
  designation String?
  industry    String?
  website     String?

  // --- LEAD METADATA ---
  leadsource String?
  leadstatus String?

  // Vtiger sends "0.00000000" as string
  annualrevenue String?

  rating String?

  // Vtiger sends "0" as string
  noofemployees String?

  // Example: "19x19"
  assigned_user_id String?

  source  String? @default("CRM")
  starred String? @default("0") // "0" | "1"
  tags    String?

  // --- ADDRESS INFO ---
  lane    String?
  code    String?
  city    String?
  country String?
  state   String?
  pobox   String?

  // --- CUSTOM FIELDS (FROM DESCRIBE + PAYLOAD) ---
  cf_883 String?

  // StatusEMR
  cf_941 String? @default("Pending")

  // Appointment Booked
  cf_943 String? @default("No")

  // No of Appointments
  cf_945 String?

  // Appointment Details (can be null) - using LongText for large HTML content
  cf_947 String? @db.LongText

  // --- MISC ---
  description String? @db.Text

  // "0" | "1"
  emailoptout String? @default("0")

  // --- VTIGER TIMESTAMPS ---
  // Converted to DateTime when inserting
  createdtime  DateTime?
  modifiedtime DateTime?
  modifiedby   String?

  // --- RAW BACKUP (VERY IMPORTANT) ---
  // Keeps original payload forever
  rawData Json?

  // --- SYSTEM ---
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([clientId])
  @@index([email])
  @@index([vtigerId])
}

model Appointment {
  id       Int    @id @default(autoincrement())
  clientId Int
  client   Client @relation(fields: [clientId], references: [id], onDelete: Cascade)

  // IntakeQ Primary ID
  intakeQId String @unique

  // Client Info
  clientName        String?
  clientEmail       String?
  clientPhone       String?
  clientDateOfBirth String?
  intakeQClientId   Int?

  // Appointment Status & Details
  status       String?
  startDate    BigInt?
  endDate      BigInt?
  duration     Int?
  serviceName  String?
  serviceId    String?
  locationName String?
  locationId   String?
  price        Float?

  // Practitioner Info
  practitionerName  String?
  practitionerEmail String?
  practitionerId    String?

  // Timing Strings
  startDateIso            String?
  endDateIso              String?
  startDateLocal          String?
  endDateLocal            String?
  startDateLocalFormatted String?

  // Financial & Notes
  invoiceId        String?
  invoiceNumber    Int?
  clientNote       String? @db.Text
  practitionerNote String? @db.Text

  // Telehealth Object from appointments.json
  telehealthInfo Json?

  // System Metadata
  intakeId                       String?
  dateCreated                    BigInt?
  createdBy                      String?
  bookedByClient                 Boolean?
  lastModified                   BigInt?
  attendanceConfirmationResponse String?
  reminderType                   String?
  placeOfService                 String?

  // Cancellations
  fullCancellationReason String? @db.Text
  cancellationReasonNote String? @db.Text
  cancellationDate       String?

  // Custom Fields & Arrays
  customFields      Json?
  additionalClients Json?

  // Raw JSON Backup
  rawData   Json?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([clientId])
  @@index([clientEmail])
}
